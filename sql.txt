-- Завдання 1

CREATE SCHEMA IF NOT EXISTS pandemic;

USE pandemic;

SELECT * FROM infectious_cases LIMIT 20;

-- Завдання 2

-- Створюю таблицю для країн
CREATE TABLE countries (
    country_id INT AUTO_INCREMENT PRIMARY KEY,
    entity VARCHAR(255) NOT NULL,
    code VARCHAR(10),
    UNIQUE(entity, code)
);

-- Заповнюю таблицю країн унікальними значеннями
INSERT INTO countries (entity, code)
SELECT DISTINCT Entity, Code FROM infectious_cases;

-- Створюю нову, нормалізовану таблицю для даних про захворювання
CREATE TABLE cases_data (
    case_id INT AUTO_INCREMENT PRIMARY KEY,
    country_id INT,
    year INT,
    number_rabies VARCHAR(255),
    FOREIGN KEY (country_id) REFERENCES countries(country_id)
);

-- Заповнюю нормалізовану таблицю, поєднуючи дані
INSERT INTO cases_data (country_id, year, number_rabies)
SELECT
    c.country_id,
    ic.Year,
    ic.Number_rabies
FROM
    infectious_cases ic
JOIN
    countries c ON ic.Entity = c.entity AND (ic.Code = c.code OR (ic.Code IS NULL AND c.code IS NULL));

SELECT COUNT(*) FROM infectious_cases;

-- Завдання 3: Аналіз даних по сказу

SELECT
    c.entity,
    c.code,
    AVG(CAST(cd.number_rabies AS DECIMAL(10, 2))) AS avg_rabies,
    MIN(CAST(cd.number_rabies AS DECIMAL(10, 2))) AS min_rabies,
    MAX(CAST(cd.number_rabies AS DECIMAL(10, 2))) AS max_rabies,
    SUM(CAST(cd.number_rabies AS DECIMAL(10, 2))) AS sum_rabies
FROM
    cases_data cd
JOIN
    countries c ON cd.country_id = c.country_id
WHERE
    cd.number_rabies IS NOT NULL AND cd.number_rabies != '' 
GROUP BY
    c.country_id
ORDER BY
    avg_rabies DESC 
LIMIT 10;

-- Завдання 4: Робота з датами

SELECT
    Year,
    FLOOR(DATEDIFF(CURDATE(), MAKEDATE(Year, 1)) / 365) AS year_difference,
    MAKEDATE(Year, 1) AS first_day_of_year
FROM
    infectious_cases
LIMIT 15;

-- Завдання 5: Створення та використання власної функції

SET GLOBAL log_bin_trust_function_creators = 1;

DELIMITER $$

DROP FUNCTION IF EXISTS CalculateYearDifference$$

CREATE FUNCTION CalculateYearDifference(input_year INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE year_diff INT;
    SET year_diff = TIMESTAMPDIFF(YEAR, MAKEDATE(input_year, 1), CURDATE());
    RETURN year_diff;
END$$

DELIMITER ;

-- Використовуємо створену функцію
SELECT
    Year,
    CalculateYearDifference(Year) AS year_difference_from_function
FROM
    infectious_cases
LIMIT 15;

